<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ra System Spherical Coordinate Visualizer</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0a0a1a 0%, #1a1a3a 50%, #0a1a2a 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        h1 {
            text-align: center;
            font-size: 2rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #ffd700, #ff6b35, #ffd700);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .subtitle {
            text-align: center;
            color: #888;
            margin-bottom: 30px;
            font-style: italic;
        }
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 30px;
        }
        @media (max-width: 1000px) {
            .main-grid { grid-template-columns: 1fr; }
        }
        .sphere-container {
            background: rgba(0,0,0,0.4);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid rgba(255,215,0,0.2);
        }
        .controls-panel {
            background: rgba(0,0,0,0.4);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid rgba(255,215,0,0.2);
        }
        .control-group {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
        }
        .control-group label {
            display: block;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #aaa;
            margin-bottom: 8px;
        }
        .control-group input[type="range"] {
            width: 100%;
            margin-bottom: 5px;
            accent-color: #ffd700;
        }
        .value-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .value { font-size: 1.5rem; font-weight: bold; font-family: monospace; }
        .semantic { font-size: 0.9rem; color: #ffd700; }

        .theta-color { color: #ff6b35; }
        .phi-color { color: #4ecdc4; }
        .omega-color { color: #a855f7; }
        .radius-color { color: #22c55e; }

        .output-section {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255,215,0,0.05);
            border-radius: 8px;
            border: 1px solid rgba(255,215,0,0.2);
        }
        .output-section h3 {
            color: #ffd700;
            margin-bottom: 10px;
            font-size: 14px;
            text-transform: uppercase;
        }
        .address-display {
            font-family: monospace;
            font-size: 1.5rem;
            text-align: center;
            padding: 10px;
            background: rgba(0,0,0,0.5);
            border-radius: 4px;
            color: #ffd700;
            letter-spacing: 2px;
        }
        .constants-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        .constant-item {
            background: rgba(255,255,255,0.02);
            padding: 8px;
            border-radius: 4px;
            font-size: 0.85rem;
        }
        .constant-item .name { color: #888; font-size: 0.75rem; }
        .constant-item .val { color: #ffd700; font-family: monospace; }

        .legend {
            margin-top: 20px;
            padding: 15px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
        }
        .legend h4 { color: #ffd700; margin-bottom: 10px; font-size: 12px; text-transform: uppercase; }
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.85rem;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
        }

        svg { display: block; margin: 0 auto; }

        .info-panel {
            margin-top: 30px;
            padding: 20px;
            background: rgba(0,0,0,0.4);
            border-radius: 16px;
            border: 1px solid rgba(255,215,0,0.2);
        }
        .info-panel h2 {
            color: #ffd700;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }
        .info-panel p {
            margin-bottom: 10px;
            line-height: 1.6;
        }
        .formula {
            font-family: monospace;
            background: rgba(255,215,0,0.1);
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            color: #ffd700;
        }

        /* RPP Token Stream Styles */
        .token-stream-panel {
            margin-top: 30px;
            padding: 20px;
            background: rgba(0,0,0,0.4);
            border-radius: 16px;
            border: 1px solid rgba(255,215,0,0.2);
        }
        .token-stream-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .token-stream-header h2 {
            color: #ffd700;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .stream-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
        }
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ef4444;
            animation: pulse 2s infinite;
        }
        .status-dot.connected { background: #22c55e; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .token-stream-container {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 10px;
        }
        .token-stream-container::-webkit-scrollbar { width: 6px; }
        .token-stream-container::-webkit-scrollbar-track { background: rgba(0,0,0,0.3); border-radius: 3px; }
        .token-stream-container::-webkit-scrollbar-thumb { background: rgba(255,215,0,0.3); border-radius: 3px; }
        .token-card {
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            border-left: 4px solid #ffd700;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .token-card.routing { border-left-color: #3b82f6; }
        .token-card.consent { border-left-color: #a855f7; }
        .token-card.etf { border-left-color: #ef4444; }
        .token-card.ripley { border-left-color: #f97315; }
        .token-card.coherence { border-left-color: #22c55e; }
        .token-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        .token-type {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 3px 8px;
            border-radius: 4px;
            background: rgba(255,215,0,0.2);
            color: #ffd700;
        }
        .token-type.routing { background: rgba(59,130,246,0.2); color: #3b82f6; }
        .token-type.consent { background: rgba(168,85,247,0.2); color: #a855f7; }
        .token-type.etf { background: rgba(239,68,68,0.2); color: #ef4444; }
        .token-type.ripley { background: rgba(249,115,21,0.2); color: #f97315; }
        .token-type.coherence { background: rgba(34,197,94,0.2); color: #22c55e; }
        .token-time { font-size: 0.7rem; color: #666; font-family: monospace; }
        .token-id { font-family: monospace; font-size: 0.75rem; color: #888; margin-bottom: 10px; }
        .token-metrics {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 10px;
        }
        .metric {
            text-align: center;
            padding: 6px;
            background: rgba(0,0,0,0.3);
            border-radius: 6px;
        }
        .metric-label { font-size: 0.6rem; text-transform: uppercase; color: #666; margin-bottom: 2px; }
        .metric-value { font-size: 0.9rem; font-weight: bold; font-family: monospace; }
        .metric-value.theta { color: #ff6b35; }
        .metric-value.phi { color: #4ecdc4; }
        .metric-value.coherence { color: #22c55e; }
        .metric-value.entropy { color: #a855f7; }
        .attractor-viz {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            margin-top: 8px;
        }
        .attractor-shape { font-size: 1.5rem; }
        .attractor-details { flex: 1; }
        .attractor-details .field-shape { font-weight: bold; color: #ffd700; text-transform: capitalize; font-size: 0.85rem; }
        .attractor-details .field-info { font-size: 0.75rem; color: #888; }
        .spin-indicator {
            width: 24px;
            height: 24px;
            border: 2px solid #ffd700;
            border-radius: 50%;
            position: relative;
        }
        .spin-indicator::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 50%;
            width: 0;
            height: 0;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-bottom: 6px solid #ffd700;
            transform: translateX(-50%);
        }
        .spin-indicator.ccw { animation: spinCCW 2s linear infinite; }
        .spin-indicator.cw { animation: spinCW 2s linear infinite; }
        @keyframes spinCCW { from { transform: rotate(0deg); } to { transform: rotate(-360deg); } }
        @keyframes spinCW { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .token-empty { text-align: center; padding: 40px; color: #666; }
        .token-empty-icon { font-size: 2.5rem; margin-bottom: 10px; opacity: 0.5; }
        .stream-controls { display: flex; gap: 10px; }
        .stream-btn {
            padding: 6px 12px;
            border: 1px solid rgba(255,215,0,0.3);
            background: rgba(255,215,0,0.1);
            color: #ffd700;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s;
        }
        .stream-btn:hover { background: rgba(255,215,0,0.2); }
        .stream-btn.active { background: rgba(255,215,0,0.3); }
        .harmonic-bar {
            height: 3px;
            background: linear-gradient(90deg, #22c55e, #ffd700, #ef4444);
            border-radius: 2px;
            margin-top: 6px;
            position: relative;
        }
        .harmonic-marker {
            position: absolute;
            top: -4px;
            width: 8px;
            height: 8px;
            background: #fff;
            border-radius: 50%;
            transform: translateX(-50%);
            box-shadow: 0 0 4px rgba(255,255,255,0.5);
        }
        .role-badge {
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 3px;
            background: rgba(255,255,255,0.1);
            color: #aaa;
            margin-left: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Ra System Spherical Coordinates</h1>
        <p class="subtitle">Interactive visualization of Ra-Canonical v2.0 dimensional mapping</p>

        <div class="main-grid">
            <div class="sphere-container">
                <svg id="sphereViz" viewBox="0 0 600 600" width="100%" height="auto">
                    <defs>
                        <radialGradient id="sphereGradient" cx="30%" cy="30%">
                            <stop offset="0%" stop-color="#1a1a3a"/>
                            <stop offset="100%" stop-color="#0a0a1a"/>
                        </radialGradient>
                        <filter id="glow">
                            <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
                            <feMerge>
                                <feMergeNode in="coloredBlur"/>
                                <feMergeNode in="SourceGraphic"/>
                            </feMerge>
                        </filter>
                        <linearGradient id="racGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" stop-color="#22c55e"/>
                            <stop offset="50%" stop-color="#ffd700"/>
                            <stop offset="100%" stop-color="#ef4444"/>
                        </linearGradient>
                    </defs>

                    <!-- Background -->
                    <rect width="600" height="600" fill="url(#sphereGradient)"/>

                    <!-- RAC Shells (6 concentric circles) -->
                    <g id="racShells">
                        <circle cx="300" cy="300" r="250" fill="none" stroke="#ef444440" stroke-width="2" stroke-dasharray="5,5"/>
                        <circle cx="300" cy="300" r="210" fill="none" stroke="#f9731540" stroke-width="2" stroke-dasharray="5,5"/>
                        <circle cx="300" cy="300" r="170" fill="none" stroke="#ffd70040" stroke-width="2" stroke-dasharray="5,5"/>
                        <circle cx="300" cy="300" r="130" fill="none" stroke="#84cc1640" stroke-width="2" stroke-dasharray="5,5"/>
                        <circle cx="300" cy="300" r="90" fill="none" stroke="#22c55e40" stroke-width="2" stroke-dasharray="5,5"/>
                        <circle cx="300" cy="300" r="50" fill="none" stroke="#10b98140" stroke-width="2" stroke-dasharray="5,5"/>
                    </g>

                    <!-- 27 Repitan Sector Lines -->
                    <g id="repitanSectors" stroke="#ff6b3530" stroke-width="1">
                        <!-- Generated dynamically -->
                    </g>

                    <!-- Main sphere outline -->
                    <circle cx="300" cy="300" r="250" fill="none" stroke="#ffd70060" stroke-width="2"/>

                    <!-- Equator (phi = 3) -->
                    <ellipse cx="300" cy="300" rx="250" ry="60" fill="none" stroke="#4ecdc450" stroke-width="1" stroke-dasharray="10,5"/>

                    <!-- Meridian -->
                    <ellipse cx="300" cy="300" rx="60" ry="250" fill="none" stroke="#4ecdc430" stroke-width="1" stroke-dasharray="10,5"/>

                    <!-- Current position marker -->
                    <g id="positionGroup">
                        <circle id="positionGlow" cx="300" cy="300" r="20" fill="#ffd70030" filter="url(#glow)"/>
                        <circle id="positionMarker" cx="300" cy="300" r="12" fill="#ffd700" stroke="#fff" stroke-width="2"/>
                        <circle id="positionCore" cx="300" cy="300" r="4" fill="#fff"/>
                    </g>

                    <!-- Labels -->
                    <text x="300" y="30" text-anchor="middle" fill="#4ecdc4" font-size="12">RAC 6 (Restricted)</text>
                    <text x="300" y="580" text-anchor="middle" fill="#22c55e" font-size="12">RAC 1 (Open)</text>
                    <text x="570" y="305" text-anchor="end" fill="#ff6b35" font-size="12">Theta</text>
                    <text x="305" y="50" text-anchor="start" fill="#a855f7" font-size="12">Omega</text>

                    <!-- Ankh symbol at center -->
                    <text x="300" y="310" text-anchor="middle" fill="#ffd70080" font-size="40">&#9765;</text>
                </svg>
            </div>

            <div class="controls-panel">
                <div class="control-group">
                    <label>Theta (Semantic Sector) - 27 Repitans</label>
                    <input type="range" id="theta" min="1" max="27" value="9">
                    <div class="value-display">
                        <span class="value theta-color" id="thetaValue">9</span>
                        <span class="semantic" id="thetaSemantic">COMPLETION</span>
                    </div>
                    <div style="font-size:0.8rem;color:#888;margin-top:5px;">
                        Repitan: <span id="repitanValue">0.333</span>
                    </div>
                </div>

                <div class="control-group">
                    <label>Phi (Access Level) - 6 RACs</label>
                    <input type="range" id="phi" min="1" max="6" value="3">
                    <div class="value-display">
                        <span class="value phi-color" id="phiValue">3</span>
                        <span class="semantic" id="phiSemantic">RAC 3 (Verified)</span>
                    </div>
                    <div style="font-size:0.8rem;color:#888;margin-top:5px;">
                        Threshold: <span id="racThreshold">0.900</span>
                    </div>
                </div>

                <div class="control-group">
                    <label>Harmonic (Omega Tier) - 5 Formats</label>
                    <input type="range" id="omega" min="0" max="4" value="2">
                    <div class="value-display">
                        <span class="value omega-color" id="omegaValue">2</span>
                        <span class="semantic" id="omegaSemantic">GREEN</span>
                    </div>
                </div>

                <div class="control-group">
                    <label>Radius (Emergence Intensity) - Ankh Normalized</label>
                    <input type="range" id="radius" min="0" max="255" value="128">
                    <div class="value-display">
                        <span class="value radius-color" id="radiusValue">128</span>
                        <span class="semantic" id="radiusSemantic">0.502</span>
                    </div>
                    <div style="font-size:0.8rem;color:#888;margin-top:5px;">
                        Ankh-scaled: <span id="ankhScaled">2.555</span>
                    </div>
                </div>

                <div class="output-section">
                    <h3>Ra-Canonical Address (32-bit)</h3>
                    <div class="address-display" id="addressDisplay">0x48602000</div>
                    <div class="constants-grid">
                        <div class="constant-item">
                            <div class="name">Ankh</div>
                            <div class="val">5.08938</div>
                        </div>
                        <div class="constant-item">
                            <div class="name">Omega</div>
                            <div class="val">1.005663</div>
                        </div>
                        <div class="constant-item">
                            <div class="name">Hunab</div>
                            <div class="val">1.060288</div>
                        </div>
                        <div class="constant-item">
                            <div class="name">Phi Green</div>
                            <div class="val">1.62</div>
                        </div>
                    </div>
                </div>

                <div class="legend">
                    <h4>Omega Format Hierarchy</h4>
                    <div class="legend-item">
                        <div class="legend-color" style="background:#ef4444;"></div>
                        <span>RED (0) - Highest Precision</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background:#f97315;"></div>
                        <span>OMEGA MAJOR (1)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background:#22c55e;"></div>
                        <span>GREEN (2) - Standard</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background:#3b82f6;"></div>
                        <span>OMEGA MINOR (3)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background:#6366f1;"></div>
                        <span>BLUE (4) - Lowest Precision</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="info-panel">
            <h2>Ra System Architecture Relationship</h2>
            <p>The Ra System provides a mathematically grounded framework derived from "The Rods of Amon Ra" by Wesley H. Bateman. It maps seamlessly to the <strong>Ra-Canonical v2.0</strong> address format used in SPIRAL (RPP + Consent Header).</p>

            <div class="formula">
                [theta:5][phi:3][h:3][r:8][reserved:13] = 32 bits
            </div>

            <p><strong>Dimensional Mapping:</strong></p>
            <ul style="margin-left:20px;line-height:2;">
                <li><strong>Theta (5 bits, 1-27):</strong> Maps to 27 Repitans - fractional parts of 27 that define semantic sectors. Repitan(n) = n/27.</li>
                <li><strong>Phi (3 bits, 1-6):</strong> Maps to 6 RAC (Resonant Access Constant) levels - consent sensitivity thresholds derived from the Great Pyramid proportions.</li>
                <li><strong>Harmonic (3 bits, 0-4):</strong> Maps to 5 Omega format tiers (Red > Omega Major > Green > Omega Minor > Blue) - coherence depth/precision levels.</li>
                <li><strong>Radius (8 bits, 0-255):</strong> Ankh-normalized emergence intensity scalar. Ankh = 5.08938 = Pi_red x Phi_green.</li>
            </ul>

            <div class="formula">
                Ankh = Pi_red x Phi_green = 3.141592592 x 1.62 = 5.08938
            </div>

            <p><strong>What Makes Ra System Unique:</strong></p>
            <ul style="margin-left:20px;line-height:2;">
                <li><strong>Coherence-First Design:</strong> Access gating uses RAC thresholds (not arbitrary percentages), ensuring mathematically grounded consent decisions.</li>
                <li><strong>Harmonic Resonance:</strong> The Omega ratio (1.005662978) enables format conversions that preserve harmonic relationships across precision tiers.</li>
                <li><strong>Spectral Alignment:</strong> Constants like the Balmer constant (364.5) and Rydberg constant connect to hydrogen spectral lines, grounding the system in physical reality.</li>
                <li><strong>Pyramid Geometry:</strong> RAC values derive from Great Pyramid base divisions (360, 364.5, 400, 437.4, 500, 572.76), providing ancient geometric validation.</li>
            </ul>
        </div>
        <!-- RPP Token Stream Panel -->
        <div class="token-stream-panel">
            <div class="token-stream-header">
                <h2>
                    RPP Token Stream
                    <span class="stream-status">
                        <span class="status-dot" id="wsStatus"></span>
                        <span id="wsStatusText">Disconnected</span>
                    </span>
                </h2>
                <div class="stream-controls">
                    <button class="stream-btn" id="btnConnect" onclick="toggleConnection()">Connect</button>
                    <button class="stream-btn" id="btnClear" onclick="clearTokens()">Clear</button>
                    <button class="stream-btn" id="btnDemo" onclick="addDemoToken()">Demo</button>
                </div>
            </div>
            <div class="token-stream-container" id="tokenContainer">
                <div class="token-empty" id="emptyState">
                    <div class="token-empty-icon">&#9765;</div>
                    <div>No tokens yet</div>
                    <div style="font-size:0.8rem;margin-top:5px;">Connect to SPIRAL service or click Demo</div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // Ra System Constants
        const ANKH = 5.08938;
        const OMEGA = 1.005662978;
        const HUNAB = 1.0602875;
        const PHI_GREEN = 1.62;

        // 27 Repitans
        const REPITANS = {};
        for (let i = 1; i <= 27; i++) {
            REPITANS[i] = i / 27;
        }

        // Semantic sector names
        const SECTORS = {
            1: "GENESIS", 2: "GROWTH", 3: "STRUCTURE", 4: "RELATION",
            5: "LIFE", 6: "HARMONY", 7: "SPIRIT", 8: "INFINITY",
            9: "COMPLETION", 10: "RENEWAL", 11: "MASTERY", 12: "SACRIFICE",
            13: "DEATH", 14: "TEMPERANCE", 15: "SHADOW", 16: "TOWER",
            17: "STAR", 18: "THRESHOLD", 19: "SUN", 20: "JUDGMENT",
            21: "WORLD", 22: "FOOL", 23: "MAGICIAN", 24: "PRIESTESS",
            25: "EMPRESS", 26: "EMPEROR", 27: "UNITY"
        };

        // 6 RAC values and labels
        const RAC_VALUES = {
            1: 0.6361725,
            2: 0.628318519,
            3: 0.57255525,
            4: 0.523598765,
            5: 0.4580442,
            6: 0.3998594565
        };
        const RAC_LABELS = {
            1: "RAC 1 (Public)",
            2: "RAC 2 (Registered)",
            3: "RAC 3 (Verified)",
            4: "RAC 4 (Consent-Affirmed)",
            5: "RAC 5 (Coherence-Gated)",
            6: "RAC 6 (Full Consent)"
        };

        // 5 Omega tiers
        const OMEGA_TIERS = ["RED", "OMEGA MAJOR", "GREEN", "OMEGA MINOR", "BLUE"];
        const OMEGA_COLORS = ["#ef4444", "#f97315", "#22c55e", "#3b82f6", "#6366f1"];

        // Draw 27 Repitan sector lines
        function drawRepitanSectors() {
            const svg = document.getElementById('sphereViz');
            const group = document.getElementById('repitanSectors');
            group.innerHTML = '';

            for (let i = 1; i <= 27; i++) {
                const angle = (i / 27) * 2 * Math.PI - Math.PI / 2;
                const x2 = 300 + Math.cos(angle) * 250;
                const y2 = 300 + Math.sin(angle) * 250;

                const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                line.setAttribute("x1", "300");
                line.setAttribute("y1", "300");
                line.setAttribute("x2", x2);
                line.setAttribute("y2", y2);
                group.appendChild(line);
            }
        }

        // Encode address
        function encodeAddress(theta, phi, omega, radius) {
            // Ra-Canonical v2.0: [theta:5][phi:3][h:3][r:8][reserved:13]
            return (theta << 27) | (phi << 24) | (omega << 21) | (radius << 13);
        }

        // Update display
        function updateDisplay() {
            const theta = parseInt(document.getElementById('theta').value);
            const phi = parseInt(document.getElementById('phi').value);
            const omega = parseInt(document.getElementById('omega').value);
            const radius = parseInt(document.getElementById('radius').value);

            // Update values
            document.getElementById('thetaValue').textContent = theta;
            document.getElementById('thetaSemantic').textContent = SECTORS[theta];
            document.getElementById('repitanValue').textContent = REPITANS[theta].toFixed(3);

            document.getElementById('phiValue').textContent = phi;
            document.getElementById('phiSemantic').textContent = RAC_LABELS[phi];
            document.getElementById('racThreshold').textContent = (RAC_VALUES[phi] / RAC_VALUES[1]).toFixed(3);

            document.getElementById('omegaValue').textContent = omega;
            document.getElementById('omegaSemantic').textContent = OMEGA_TIERS[omega];

            document.getElementById('radiusValue').textContent = radius;
            const normalized = radius / 255;
            document.getElementById('radiusSemantic').textContent = normalized.toFixed(3);
            document.getElementById('ankhScaled').textContent = (normalized * ANKH).toFixed(3);

            // Encode address
            const address = encodeAddress(theta, phi, omega, radius);
            document.getElementById('addressDisplay').textContent = '0x' + address.toString(16).toUpperCase().padStart(8, '0');

            // Update position marker
            const thetaAngle = (theta / 27) * 2 * Math.PI - Math.PI / 2;
            const phiScale = 1 - (phi - 1) / 5; // RAC 1 = outer, RAC 6 = inner
            const markerRadius = 50 + phiScale * 200;

            const x = 300 + Math.cos(thetaAngle) * markerRadius * 0.9;
            const y = 300 + Math.sin(thetaAngle) * markerRadius * 0.4;

            const marker = document.getElementById('positionMarker');
            const glow = document.getElementById('positionGlow');
            const core = document.getElementById('positionCore');

            marker.setAttribute('cx', x);
            marker.setAttribute('cy', y);
            marker.setAttribute('fill', OMEGA_COLORS[omega]);

            glow.setAttribute('cx', x);
            glow.setAttribute('cy', y);
            glow.setAttribute('r', 10 + normalized * 20);
            glow.setAttribute('fill', OMEGA_COLORS[omega] + '40');

            core.setAttribute('cx', x);
            core.setAttribute('cy', y);
        }

        // Initialize
        drawRepitanSectors();
        updateDisplay();

        // Event listeners
        ['theta', 'phi', 'omega', 'radius'].forEach(id => {
            document.getElementById(id).addEventListener('input', updateDisplay);
        });
    
        // =================================================================
        // RPP TOKEN STREAM - WebSocket Connection and Rendering
        // =================================================================

        const SPIRAL_WS_URL = 'ws://localhost:5000/ws';
        let ws = null;
        let tokenCount = 0;
        const MAX_TOKENS = 50;

        // Field shape icons
        const SHAPE_ICONS = {
            'double_toroid': 'â—Ž',
            'vortex': 'âŸ³',
            'bowl': 'â—¡',
            'spiral': 'ðŸŒ€',
            'torus': 'â—‰'
        };

        // Demo token data
        const DEMO_TOKENS = [
            {
                event_type: 'packet_routed',
                token: {
                    token_id: 'spiral-route-demo-001',
                    theta: 0.452871,
                    phi: 0.370212,
                    coherence: 0.920000,
                    entropy_delta: 0.029488,
                    role: 'Magnetic Field Engineer',
                    attractor_signature: { field_shape: 'double_toroid', vortex_spin: 'ccw', field_strength: 0.684523 },
                    harmonic_resonance: { scalar_harmonic: 0.562341, voltage_ring_index: 9, rotation_phase: 144.0 }
                }
            },
            {
                event_type: 'consent_changed',
                token: {
                    token_id: 'spiral-consent-demo-002',
                    theta: 0.657892,
                    phi: 0.568234,
                    coherence: 0.780000,
                    entropy_delta: -0.058911,
                    role: 'Ematician',
                    attractor_signature: { field_shape: 'vortex', vortex_spin: 'cw', field_strength: 0.598712 },
                    harmonic_resonance: { scalar_harmonic: 0.523456, voltage_ring_index: 7, rotation_phase: 252.0 }
                },
                extra_data: { old_state: 'FULL_CONSENT', new_state: 'DIMINISHED_CONSENT' }
            },
            {
                event_type: 'etf_activated',
                token: {
                    token_id: 'spiral-etf-demo-003',
                    theta: 0.756789,
                    phi: 0.734567,
                    coherence: 0.318300,
                    entropy_delta: 0.193997,
                    role: 'Time Compression Experimenter',
                    attractor_signature: { field_shape: 'bowl', vortex_spin: 'counter-rotating', field_strength: 0.723456 },
                    harmonic_resonance: { scalar_harmonic: 0.356789, voltage_ring_index: 10, rotation_phase: 36.0 }
                },
                extra_data: { reason: 'Emergency freeze triggered' }
            },
            {
                event_type: 'ripley_alert',
                token: {
                    token_id: 'spiral-ripley-demo-004',
                    theta: 0.289345,
                    phi: 0.198456,
                    coherence: 0.650000,
                    entropy_delta: 0.088217,
                    role: 'Ematician',
                    attractor_signature: { field_shape: 'vortex', vortex_spin: 'ccw', field_strength: 0.534567 },
                    harmonic_resonance: { scalar_harmonic: 0.512345, voltage_ring_index: 6, rotation_phase: 324.0 }
                },
                extra_data: { confidence: 0.8, discontinuity: true }
            }
        ];

        function getEventClass(eventType) {
            if (eventType.includes('route') || eventType.includes('packet')) return 'routing';
            if (eventType.includes('consent')) return 'consent';
            if (eventType.includes('etf')) return 'etf';
            if (eventType.includes('ripley')) return 'ripley';
            if (eventType.includes('coherence')) return 'coherence';
            return '';
        }

        function formatTime(timestamp) {
            const date = timestamp ? new Date(timestamp) : new Date();
            return date.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }

        function createTokenCard(event) {
            const token = event.token || {};
            const eventClass = getEventClass(event.event_type || '');
            const shapeIcon = SHAPE_ICONS[token.attractor_signature?.field_shape] || 'â—‹';
            const spinClass = token.attractor_signature?.vortex_spin === 'ccw' ? 'ccw' :
                              token.attractor_signature?.vortex_spin === 'cw' ? 'cw' : '';

            const card = document.createElement('div');
            card.className = 'token-card ' + eventClass;

            card.innerHTML = `
                <div class="token-header">
                    <span class="token-type ${eventClass}">${(event.event_type || 'unknown').replace(/_/g, ' ')}</span>
                    <span class="token-time">${formatTime(event.timestamp)}</span>
                </div>
                <div class="token-id">${token.token_id || 'N/A'}<span class="role-badge">${token.role || ''}</span></div>
                <div class="token-metrics">
                    <div class="metric">
                        <div class="metric-label">Theta</div>
                        <div class="metric-value theta">${(token.theta || 0).toFixed(4)}</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Phi</div>
                        <div class="metric-value phi">${(token.phi || 0).toFixed(4)}</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Coherence</div>
                        <div class="metric-value coherence">${(token.coherence || 0).toFixed(4)}</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Entropy Î”</div>
                        <div class="metric-value entropy">${(token.entropy_delta || 0).toFixed(4)}</div>
                    </div>
                </div>
                <div class="attractor-viz">
                    <div class="attractor-shape">${shapeIcon}</div>
                    <div class="attractor-details">
                        <div class="field-shape">${token.attractor_signature?.field_shape || 'unknown'}</div>
                        <div class="field-info">Strength: ${(token.attractor_signature?.field_strength || 0).toFixed(3)} | Ring: ${token.harmonic_resonance?.voltage_ring_index || 0}</div>
                    </div>
                    <div class="spin-indicator ${spinClass}" title="${token.attractor_signature?.vortex_spin || 'none'}"></div>
                </div>
                <div class="harmonic-bar">
                    <div class="harmonic-marker" style="left: ${((token.harmonic_resonance?.scalar_harmonic || 0.5) * 100)}%"></div>
                </div>
            `;

            return card;
        }

        function addToken(event) {
            const container = document.getElementById('tokenContainer');
            const emptyState = document.getElementById('emptyState');

            if (emptyState) {
                emptyState.style.display = 'none';
            }

            const card = createTokenCard(event);
            container.insertBefore(card, container.firstChild);

            tokenCount++;

            // Remove old tokens if over limit
            while (container.children.length > MAX_TOKENS + 1) {
                container.removeChild(container.lastChild);
            }
        }

        function clearTokens() {
            const container = document.getElementById('tokenContainer');
            container.innerHTML = `
                <div class="token-empty" id="emptyState">
                    <div class="token-empty-icon">&#9765;</div>
                    <div>No tokens yet</div>
                    <div style="font-size:0.8rem;margin-top:5px;">Connect to SPIRAL service or click Demo</div>
                </div>
            `;
            tokenCount = 0;
        }

        function addDemoToken() {
            const randomEvent = DEMO_TOKENS[Math.floor(Math.random() * DEMO_TOKENS.length)];
            const event = JSON.parse(JSON.stringify(randomEvent));
            event.timestamp = new Date().toISOString();
            event.token.token_id = event.token.token_id.replace('demo', Date.now());

            // Add some randomness
            event.token.theta = Math.random();
            event.token.phi = Math.random();
            event.token.coherence = 0.3 + Math.random() * 0.7;
            event.token.entropy_delta = (Math.random() - 0.5) * 0.2;

            addToken(event);
        }

        function toggleConnection() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.close();
            } else {
                connect();
            }
        }

        function connect() {
            const statusDot = document.getElementById('wsStatus');
            const statusText = document.getElementById('wsStatusText');
            const btnConnect = document.getElementById('btnConnect');

            statusText.textContent = 'Connecting...';

            try {
                ws = new WebSocket(SPIRAL_WS_URL);

                ws.onopen = function() {
                    statusDot.classList.add('connected');
                    statusText.textContent = 'Connected';
                    btnConnect.textContent = 'Disconnect';
                    console.log('[TokenStream] Connected to SPIRAL service');
                };

                ws.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        if (data.type === 'token' || data.event_type) {
                            addToken(data);
                        }
                    } catch (e) {
                        console.warn('[TokenStream] Failed to parse message:', e);
                    }
                };

                ws.onclose = function() {
                    statusDot.classList.remove('connected');
                    statusText.textContent = 'Disconnected';
                    btnConnect.textContent = 'Connect';
                    console.log('[TokenStream] Disconnected from SPIRAL service');
                };

                ws.onerror = function(error) {
                    statusDot.classList.remove('connected');
                    statusText.textContent = 'Error';
                    btnConnect.textContent = 'Connect';
                    console.error('[TokenStream] WebSocket error:', error);
                };
            } catch (e) {
                statusText.textContent = 'Failed';
                console.error('[TokenStream] Connection failed:', e);
            }
        }

    </script>
</body>
</html>
