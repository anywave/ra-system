name: Haskell Tests

on:
  push:
    branches: [master, main]
    paths:
      - 'haskell/**'
      - '.github/workflows/haskell.yml'
    tags:
      - 'haskell-v*.*.*'
  pull_request:
    branches: [master, main]
    paths:
      - 'haskell/**'
      - '.github/workflows/haskell.yml'
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        ghc: ['9.4', '9.6', '9.8']

    steps:
      - uses: actions/checkout@v4

      - name: Set up GHC ${{ matrix.ghc }}
        uses: haskell-actions/setup@v2
        with:
          ghc-version: ${{ matrix.ghc }}
          cabal-version: 'latest'

      - name: Cache Cabal
        uses: actions/cache@v4
        with:
          path: |
            ~/.cabal/store
            dist-newstyle
          key: ${{ runner.os }}-ghc-${{ matrix.ghc }}-${{ hashFiles('haskell/ra-system.cabal') }}
          restore-keys: |
            ${{ runner.os }}-ghc-${{ matrix.ghc }}-

      - name: Update Cabal
        working-directory: haskell
        run: cabal update

      - name: Build
        working-directory: haskell
        run: cabal build all --enable-tests

      - name: Run tests
        working-directory: haskell
        run: cabal test all --enable-tests --test-show-details=direct

  # Build source distribution for Hackage
  sdist:
    name: Build Source Distribution
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4

      - name: Set up GHC
        uses: haskell-actions/setup@v2
        with:
          ghc-version: '9.6'
          cabal-version: 'latest'

      - name: Update Cabal
        working-directory: haskell
        run: cabal update

      - name: Build sdist
        working-directory: haskell
        run: cabal sdist

      - name: Upload sdist artifact
        uses: actions/upload-artifact@v4
        with:
          name: hackage-sdist
          path: haskell/dist-newstyle/sdist/*.tar.gz

  # Publish to Hackage (only on haskell-v*.*.* tags)
  publish:
    name: Publish to Hackage
    needs: [test, sdist]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/haskell-v')
    environment: hackage

    steps:
      - name: Download sdist
        uses: actions/download-artifact@v4
        with:
          name: hackage-sdist
          path: sdist/

      - name: Set up GHC
        uses: haskell-actions/setup@v2
        with:
          ghc-version: '9.6'
          cabal-version: 'latest'

      - name: Upload to Hackage
        env:
          HACKAGE_USERNAME: ${{ secrets.HACKAGE_USERNAME }}
          HACKAGE_TOKEN: ${{ secrets.HACKAGE_PASSWORD }}
        run: |
          # Use command-line args for authentication
          cabal upload --publish -u "$HACKAGE_USERNAME" -p "$HACKAGE_TOKEN" sdist/*.tar.gz
